{% extends 'base.html' %}

{% block title %}AI Assistant{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://code.jquery.com/jquery-3.2.1.min.js" 
            integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" 
            crossorigin="anonymous"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='js/popper.min.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='js/bootstrap.min.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='js/script.js') }}"></script>
    {{ moment.include_moment(local_js=url_for('static', filename='js/moment-with-locales.min.js')) }}
<script>
    $(function() {
        let chatHistory = [];
        
        // 发送消息表单处理
        $('#chat-form').on('submit', function(e) {
            e.preventDefault();
            sendMessage(); // 提取为单独的发送函数
        });

        // 监听输入框的键盘事件
        $('#user-input').on('keydown', function(e) {
            // 当按下回车键且没有按住Shift键时
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault(); // 阻止默认换行行为
                $('#chat-form').submit(); // 触发表单提交
            }
        });

        // 发送消息的函数
        function sendMessage() {
            const userMessage = $('#user-input').val().trim();
            if (!userMessage) {
                alert('请输入消息内容');
                return;
            }
            
            // 添加用户消息到聊天历史
            addMessageToHistory('user', userMessage);
            
            // 清空输入框
            $('#user-input').val('');
            
            // 禁用发送按钮
            $('#send-btn').prop('disabled', true).text('发送中...');
            
            // 添加一个空的助手消息容器用于实时更新
            let assistantMessageElement = $('<div class="message assistant-message"><div class="message-content"></div></div>');
            $('#chat-history').append(assistantMessageElement);
            scrollToBottom();
            
            let fullResponse = "";
            
            // 使用Fetch API处理流式响应
            fetch("{{ url_for('ai.chat') }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: userMessage,
                    history: chatHistory
                })
            }).then(response => {
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                function readStream() {
                    return reader.read().then(({ done, value }) => {
                        if (done) {
                            // 完成后启用发送按钮
                            $('#send-btn').prop('disabled', false).text('发送');
                            return;
                        }
                        
                        // 解码接收到的内容
                        const chunk = decoder.decode(value, { stream: true });
                        try {
                            // 解析SSE格式的数据
                            const lines = chunk.split('\n');
                            for (const line of lines) {
                                if (line.startsWith('data:')) {
                                    const dataStr = line.substring(5).trim();
                                    if (dataStr) {
                                        const data = JSON.parse(dataStr);
                                        
                                        if (data.error) {
                                            addMessageToHistory('error', data.error);
                                            assistantMessageElement.remove();
                                        } else if (!data.done) {
                                            // 实时添加内容到助手消息
                                            fullResponse += data.response;
                                            assistantMessageElement.find('.message-content').text(fullResponse);
                                        } else {
                                            // 处理完成状态，更新聊天历史
                                            chatHistory = data.history;
                                        }
                                    }
                                }
                            }
                        } catch (e) {
                            console.error('解析响应出错:', e);
                        }
                        
                        scrollToBottom();
                        return readStream();
                    });
                }
                
                return readStream();
            }).catch(error => {
                console.error('请求出错:', error);
                addMessageToHistory('error', '发送消息失败: ' + error);
                assistantMessageElement.remove();
                $('#send-btn').prop('disabled', false).text('发送');
            });
        }
        
        // 清空聊天历史
        $('#clear-btn').on('click', function() {
            $('#chat-history').empty();
            chatHistory = [];
            // 添加系统欢迎消息
            addMessageToHistory('system', '您好！我是AI助手，有什么我可以帮您的吗？');
        });
        
        // 添加消息到聊天历史
        function addMessageToHistory(role, content) {
            const messageClass = role + '-message';
            const messageDiv = $('<div class="message ' + messageClass + '"></div>');
            const contentDiv = $('<div class="message-content"></div>').text(content);
            
            messageDiv.append(contentDiv);
            $('#chat-history').append(messageDiv);
            
            // 滚动到底部
            scrollToBottom();
            
            // 如果不是系统消息和错误消息，添加到历史记录数组
            if (role !== 'system' && role !== 'error') {
                chatHistory.push({role: role, content: content});
            }
        }
        
        // 滚动到底部
        function scrollToBottom() {
            const chatHistory = $('#chat-history');
            chatHistory.scrollTop(chatHistory[0].scrollHeight);
        }
    });
</script>
<style>
    .chat-history {
        height: 500px;
        overflow-y: auto;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
        margin-bottom: 20px;
        background-color: #f8f9fa;
    }
    
    .message {
        margin-bottom: 15px;
        padding: 10px;
        border-radius: 5px;
        max-width: 80%;
    }
    
    .user-message {
        background-color: #007bff;
        color: white;
        margin-left: auto;
    }
    
    .assistant-message {
        background-color: #e9ecef;
        color: #212529;
        margin-right: auto;
    }
    
    .system-message {
        background-color: #28a745;
        color: white;
        text-align: center;
        margin-left: auto;
        margin-right: auto;
    }
    
    .error-message {
        background-color: #dc3545;
        color: white;
        text-align: center;
        margin-left: auto;
        margin-right: auto;
    }
    
    .message-content {
        word-wrap: break-word;
        white-space: pre-wrap;
    }
    
    .chat-input-area {
        margin-top: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>AI Assistant</h1>
</div>
<div class="row">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-body">
                <div id="chat-container">
                    <div id="chat-history" class="chat-history">
                        <div class="message system-message">
                            <div class="message-content">您好！我是AI助手，有什么我可以帮您的吗？</div>
                        </div>
                    </div>
                    <div class="chat-input-area">
                        <form id="chat-form">
                            <div class="form-group">
                                <textarea id="user-input" class="form-control" rows="3" placeholder="请输入您的问题..."></textarea>
                            </div>
                            <button type="submit" id="send-btn" class="btn btn-primary">发送</button>
                            <button type="button" id="clear-btn" class="btn btn-secondary">清空历史</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
